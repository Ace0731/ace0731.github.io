<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PFET - Project Finance & Effort Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom scrollbar for dark mode */
        body::-webkit-scrollbar { width: 8px; }
        body::-webkit-scrollbar-track { background: #1f2937; /* Darker track */ }
        body::-webkit-scrollbar-thumb { background: #4b5563; /* Gray thumb */ }
        body::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        /* Style for required fields */
        .required-label::after { content: ' *'; color: #ef4444; }
        /* Ensure modals are on top */
        .modal-overlay { z-index: 50; }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#2563eb', /* Blue-600 */
                        'secondary': '#1f2937', /* Gray-800 */
                        'card': '#111827', /* Gray-900 */
                        'background': '#030712', /* Gray-950 */
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-background min-h-screen text-gray-100 font-sans p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="flex justify-between items-center mb-8 pb-4 border-b border-gray-800">
            <h1 class="text-3xl md:text-4xl font-extrabold text-white flex items-center">
                <i data-lucide="layout-grid" class="w-7 h-7 mr-3 text-primary"></i>
                PFET: Project Tracker
            </h1>
            <div class="flex space-space-x-3">
                <!-- Import Button -->
                <button id="import-data-btn" class="bg-primary hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-l-lg shadow-lg transition duration-200 flex items-center">
                    <i data-lucide="upload" class="w-5 h-5 mr-1"></i>
                    Import Data
                </button>
                <!-- Export Button (now triggers direct download) -->
                <button id="export-data-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-r-lg shadow-lg transition duration-200 flex items-center">
                    <i data-lucide="download" class="w-5 h-5 mr-1"></i>
                    Export Backup
                </button>
                <button id="add-project-btn" class="bg-primary hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-lg transition duration-200 flex items-center ml-3">
                    <i data-lucide="plus" class="w-5 h-5 mr-1"></i>
                    New Project
                </button>
            </div>
        </header>

        <!-- Notification Bar (Toast) -->
        <div id="message-box" class="fixed top-4 right-4 p-4 rounded-lg shadow-xl text-white transition-opacity duration-300 opacity-0 hidden z-50"></div>

        <!-- NOTE: Data Storage Status -->
        <div class="text-xs text-yellow-500 bg-yellow-900/20 p-2 rounded-lg mb-6">
            <p>
                ⚠️ **Data Storage Notice:** Data is saved locally in your browser. Use **Export Backup** to download a JSON file for safe keeping, and **Import Data** to restore from your file.
            </p>
        </div>

        <!-- Dashboard Summary -->
        <section id="dashboard-summary" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-10">
            <!-- Summary cards will be injected here -->
        </section>

        <!-- Project List -->
        <section>
            <h2 class="text-2xl font-bold mb-4 text-white">Project Portfolio</h2>
            <div id="project-list-container" class="space-y-4">
                <p id="empty-state" class="text-center p-8 text-gray-500 hidden">
                    No projects found. Click "New Project" to add your first entry!
                </p>
            </div>
        </section>
    </div>

    <!-- Project Form Modal -->
    <div id="project-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center modal-overlay p-4">
        <div class="bg-card w-full max-w-2xl rounded-xl shadow-2xl p-6 md:p-8 transform transition-all duration-300">
            <h3 id="modal-title" class="text-xl md:text-2xl font-bold text-white mb-6 border-b border-gray-800 pb-3">Add New Project</h3>
            
            <form id="project-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                
                <!-- Hidden Input for Editing -->
                <input type="hidden" id="project-id">

                <!-- Row 1: Name and Type -->
                <div class="col-span-1">
                    <label for="name" class="required-label block text-sm font-medium text-gray-400">Project Name</label>
                    <input type="text" id="name" required class="mt-1 block w-full bg-secondary border border-gray-700 rounded-lg p-2.5 text-white focus:ring-primary focus:border-primary">
                </div>
                <div class="col-span-1">
                    <label for="type" class="block text-sm font-medium text-gray-400">Project Type</label>
                    <select id="type" class="mt-1 block w-full bg-secondary border border-gray-700 rounded-lg p-2.5 text-white focus:ring-primary focus:border-primary">
                        <option value="Client Work">Client Work</option>
                        <option value="Internal Tool">Internal Tool</option>
                        <option value="Personal Project">Personal Project</option>
                        <option value="Investment">Investment</option>
                    </select>
                </div>

                <!-- Row 2: Status and Tech Stack -->
                <div class="col-span-1">
                    <label for="status" class="block text-sm font-medium text-gray-400">Status</label>
                    <select id="status" class="mt-1 block w-full bg-secondary border border-gray-700 rounded-lg p-2.5 text-white focus:ring-primary focus:border-primary">
                        <option value="Planned">Planned</option>
                        <option value="In Progress">In Progress</option>
                        <option value="On Hold">On Hold</option>
                        <option value="Complete">Complete</option>
                    </select>
                </div>
                <div class="col-span-1">
                    <label for="techStack" class="block text-sm font-medium text-gray-400">Tech Stack (e.g., React, Node, SQL)</label>
                    <input type="text" id="techStack" class="mt-1 block w-full bg-secondary border border-gray-700 rounded-lg p-2.5 text-white focus:ring-primary focus:border-primary">
                </div>

                <!-- Row 3: Cost Metrics -->
                <div class="col-span-1">
                    <label for="totalProjectCost" class="block text-sm font-medium text-gray-400">Total Project Cost ($)</label>
                    <input type="number" id="totalProjectCost" value="0" min="0" step="0.01" class="mt-1 block w-full bg-secondary border border-gray-700 rounded-lg p-2.5 text-white focus:ring-primary focus:border-primary">
                </div>
                <div class="col-span-1">
                    <label for="myShareCost" class="block text-sm font-medium text-gray-400">My Financial Share ($)</label>
                    <input type="number" id="myShareCost" value="0" min="0" step="0.01" class="mt-1 block w-full bg-secondary border border-gray-700 rounded-lg p-2.5 text-white focus:ring-primary focus:border-primary">
                </div>

                <!-- Row 4: My Rate and Start Date -->
                <div class="col-span-1">
                    <label for="myPerDayCost" class="required-label block text-sm font-medium text-gray-400">My Per Day Cost/Rate ($)</label>
                    <input type="number" id="myPerDayCost" value="100" required min="0" step="0.01" class="mt-1 block w-full bg-secondary border border-gray-700 rounded-lg p-2.5 text-white focus:ring-primary focus:border-primary">
                </div>
                <div class="col-span-1">
                    <label for="startDate" class="block text-sm font-medium text-gray-400">Start Date</label>
                    <input type="date" id="startDate" class="mt-1 block w-full bg-secondary border border-gray-700 rounded-lg p-2.5 text-white focus:ring-primary focus:border-primary">
                </div>

                <!-- Row 5: Effort Tracking -->
                <div class="col-span-1">
                    <label for="estimatedDays" class="required-label block text-sm font-medium text-gray-400">Estimated Days</label>
                    <input type="number" id="estimatedDays" value="1" required min="1" step="1" class="mt-1 block w-full bg-secondary border border-gray-700 rounded-lg p-2.5 text-white focus:ring-primary focus:border-primary">
                </div>
                <div class="col-span-1">
                    <label for="actualDays" class="required-label block text-sm font-medium text-gray-400">Actual Days Logged</label>
                    <input type="number" id="actualDays" value="0" required min="0" step="1" class="mt-1 block w-full bg-secondary border border-gray-700 rounded-lg p-2.5 text-white focus:ring-primary focus:border-primary">
                </div>

                <!-- Row 6: Notes -->
                <div class="md:col-span-2">
                    <label for="notes" class="block text-sm font-medium text-gray-400">Essential Notes</label>
                    <textarea id="notes" rows="3" class="mt-1 block w-full bg-secondary border border-gray-700 rounded-lg p-2.5 text-white focus:ring-primary focus:border-primary"></textarea>
                </div>

                <!-- Buttons -->
                <div class="md:col-span-2 flex justify-end space-x-3 mt-4">
                    <button type="button" id="close-modal-btn" class="px-4 py-2 text-gray-400 hover:text-white rounded-lg transition duration-200">
                        Cancel
                    </button>
                    <button type="submit" class="px-6 py-2 bg-primary text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-200 shadow-md">
                        Save Project
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal (Custom Modal) -->
    <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center modal-overlay p-4">
        <div class="bg-card w-full max-w-sm rounded-xl shadow-2xl p-6">
            <h3 class="text-xl font-bold text-red-400 mb-4 flex items-center">
                <i data-lucide="alert-triangle" class="w-6 h-6 mr-2"></i>
                Confirm Deletion
            </h3>
            <p class="text-gray-300 mb-6">Are you sure you want to delete the project: <strong id="delete-project-name"></strong>? This cannot be undone.</p>
            <div class="flex justify-end space-x-3">
                <button id="cancel-delete-btn" class="px-4 py-2 text-gray-400 hover:text-white rounded-lg transition duration-200">
                    Cancel
                </button>
                <button id="confirm-delete-btn" data-project-id="" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-200">
                    Delete Permanently
                </button>
            </div>
        </div>
    </div>
    
    <!-- IMPORT DATA MODAL (Remains for pasting data) -->
    <div id="import-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center modal-overlay p-4">
        <div class="bg-card w-full max-w-4xl rounded-xl shadow-2xl p-6 md:p-8 transform transition-all duration-300">
            <h3 class="text-xl md:text-2xl font-bold text-white mb-4 border-b border-gray-800 pb-3 flex items-center">
                <i data-lucide="upload-cloud" class="w-6 h-6 mr-2 text-primary"></i>
                Import Project Data (JSON Restore)
            </h3>
            <p class="text-sm text-gray-400 mb-4">Paste the full content of your exported `.json` file below. **WARNING:** This will replace all current projects in your local storage!</p>
            
            <form id="import-form">
                <textarea id="import-json-input" rows="15" required class="mt-1 block w-full bg-secondary border border-gray-700 rounded-lg p-4 text-white text-sm font-mono focus:ring-primary focus:border-primary resize-none" placeholder='Paste JSON array here, e.g., [{"id": "...", "name": "...", ...}, ...]'>
                </textarea>
                
                <p id="import-status" class="text-red-400 text-sm mt-2 hidden">Invalid JSON format or empty data.</p>

                <div class="flex justify-end space-x-3 mt-4">
                    <button type="button" id="close-import-modal-btn" class="px-4 py-2 text-gray-400 hover:text-white rounded-lg transition duration-200">
                        Cancel
                    </button>
                    <button type="submit" class="px-6 py-2 bg-primary text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-200 shadow-md flex items-center">
                        <i data-lucide="check-circle" class="w-5 h-5 mr-1"></i>
                        Confirm Import
                    </button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // Global array to hold current project data
        let projects = [];
        const STORAGE_KEY = 'pfit_projects_v1';
        
        const projectListContainer = document.getElementById('project-list-container');
        const emptyState = document.getElementById('empty-state');
        const dashboardSummary = document.getElementById('dashboard-summary');
        const messageBox = document.getElementById('message-box');

        // --- Utility Functions ---

        /** Shows a temporary message notification (Toast). */
        const showCustomMessage = (message, type = 'green') => {
            messageBox.textContent = message;
            messageBox.className = `fixed top-4 right-4 p-4 rounded-lg shadow-xl text-white transition-opacity duration-300 z-50`;
            
            // Set background color based on type
            if (type === 'green') {
                messageBox.classList.add('bg-green-600');
            } else if (type === 'red') {
                messageBox.classList.add('bg-red-600');
            } else {
                messageBox.classList.add('bg-gray-600');
            }

            messageBox.classList.remove('hidden', 'opacity-0');
            messageBox.classList.add('opacity-100');

            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                messageBox.classList.add('opacity-0');
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                    messageBox.classList.remove('bg-green-600', 'bg-red-600', 'bg-gray-600'); // Clean up colors
                }, 300);
            }, 3000); // Display for 3 seconds
        };


        /** Generates a unique ID (UUID style) for new projects. */
        const generateId = () => {
            return crypto.randomUUID();
        };

        /** Formats a number as currency (USD). */
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 }).format(amount);
        };

        /** Calculates variance color and icon. */
        const getVarianceStyle = (variance) => {
            if (variance > 0) return { color: 'text-red-400', icon: 'trending-up', text: `+${variance} Days` };
            if (variance < 0) return { color: 'text-green-400', icon: 'trending-down', text: `${variance} Days` };
            return { color: 'text-gray-400', icon: 'minus', text: `0 Days` };
        };

        // --- Local Storage Functions ---

        /** Loads projects from localStorage. */
        const loadProjectsFromStorage = () => {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                projects = stored ? JSON.parse(stored) : [];
            } catch (e) {
                console.error("Error loading projects from localStorage:", e);
                projects = [];
                showCustomMessage("Error loading data from local storage. Starting fresh.", 'red');
            }
        };

        /** Saves the current global projects array to localStorage. */
        const saveProjectsToStorage = () => {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(projects));
                renderProjects(); // Re-render the UI after saving
            } catch (e) {
                console.error("Error saving projects to localStorage:", e);
                showCustomMessage(`Error saving data: Storage full or unavailable.`, 'red');
            }
        };


        // --- Project Data Functions (CRUD & Backup/Restore) ---

        /** Opens the modal for adding or editing a project. */
        const openModal = (project = null) => {
            const modal = document.getElementById('project-modal');
            const form = document.getElementById('project-form');
            const modalTitle = document.getElementById('modal-title');
            
            form.reset();
            document.getElementById('project-id').value = '';
            
            if (project) {
                modalTitle.textContent = `Edit Project: ${project.name}`;
                document.getElementById('project-id').value = project.id;
                document.getElementById('name').value = project.name;
                document.getElementById('type').value = project.type;
                document.getElementById('status').value = project.status;
                document.getElementById('techStack').value = project.techStack;
                document.getElementById('totalProjectCost').value = project.totalProjectCost;
                document.getElementById('myShareCost').value = project.myShareCost;
                document.getElementById('myPerDayCost').value = project.myPerDayCost;
                document.getElementById('estimatedDays').value = project.estimatedDays;
                document.getElementById('actualDays').value = project.actualDays;
                document.getElementById('startDate').value = project.startDate;
                document.getElementById('notes').value = project.notes;
            } else {
                modalTitle.textContent = 'Add New Project';
                // Set default values for new project
                document.getElementById('myPerDayCost').value = 100;
                document.getElementById('estimatedDays').value = 1;
            }
            modal.style.display = 'flex';
            // Refresh lucide icons in the modal
            lucide.createIcons();
        };

        /** Saves a new project or updates an existing one. */
        const saveProject = (e) => {
            e.preventDefault();

            const projectId = document.getElementById('project-id').value;
            
            // 1. Collect all project data fields into a single object
            const projectData = {
                name: document.getElementById('name').value,
                type: document.getElementById('type').value,
                status: document.getElementById('status').value,
                techStack: document.getElementById('techStack').value,
                
                // Convert number inputs to actual numbers
                totalProjectCost: parseFloat(document.getElementById('totalProjectCost').value || 0),
                myShareCost: parseFloat(document.getElementById('myShareCost').value || 0),
                myPerDayCost: parseFloat(document.getElementById('myPerDayCost').value || 0),
                estimatedDays: parseInt(document.getElementById('estimatedDays').value || 1),
                actualDays: parseInt(document.getElementById('actualDays').value || 0),

                startDate: document.getElementById('startDate').value,
                notes: document.getElementById('notes').value,
            };

            if (projectId) {
                // Update existing project
                const index = projects.findIndex(p => p.id === projectId);
                if (index !== -1) {
                    projects[index] = { ...projects[index], ...projectData, updatedAt: new Date().toISOString() };
                    showCustomMessage(`Project '${projectData.name}' updated successfully!`, 'green');
                }
            } else {
                // Add new project
                projects.push({ 
                    id: generateId(), // Assign new local ID
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    ...projectData 
                });
                showCustomMessage(`Project '${projectData.name}' created successfully!`, 'green');
            }
            
            saveProjectsToStorage();
            document.getElementById('project-modal').style.display = 'none';
        };
        
        /** Initiates the delete confirmation modal. */
        const initiateDelete = (projectId, projectName) => {
            document.getElementById('delete-project-name').textContent = projectName;
            document.getElementById('confirm-delete-btn').dataset.projectId = projectId;
            document.getElementById('delete-modal').style.display = 'flex';
            lucide.createIcons();
        };

        /** Deletes a project from the local array. */
        const deleteProject = () => {
            const projectId = document.getElementById('confirm-delete-btn').dataset.projectId;
            const projectName = document.getElementById('delete-project-name').textContent;

            projects = projects.filter(p => p.id !== projectId);
            
            saveProjectsToStorage();
            document.getElementById('delete-modal').style.display = 'none';
            showCustomMessage(`Project '${projectName}' deleted permanently.`, 'red');
        };

        /** **NEW**: Triggers a direct file download of the JSON data. */
        const initiateExport = () => {
            if (projects.length === 0) {
                showCustomMessage("No data to export. Add some projects first!", 'red');
                return;
            }
            
            const jsonString = JSON.stringify(projects, null, 2);
            // Create a filename using today's date
            const dateStr = new Date().toISOString().split('T')[0];
            const filename = `PFET_Backup_${dateStr}.json`;

            // Create a Blob from the JSON string
            const blob = new Blob([jsonString], { type: 'application/json' });
            
            // Create a temporary link element
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;

            // Trigger the download immediately
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showCustomMessage(`Backup file '${filename}' downloaded successfully!`, 'green');
        };
        
        /** Opens the import modal. */
        const initiateImport = () => {
            document.getElementById('import-json-input').value = '';
            document.getElementById('import-status').classList.add('hidden');
            document.getElementById('import-modal').style.display = 'flex';
        };

        /** Handles the import of projects from a pasted JSON string. */
        const importData = (e) => {
            e.preventDefault();
            const inputElement = document.getElementById('import-json-input');
            const statusElement = document.getElementById('import-status');
            const jsonString = inputElement.value.trim();

            statusElement.classList.add('hidden');
            statusElement.classList.add('text-red-400'); // Default to red status
            
            if (!jsonString) {
                statusElement.textContent = 'Please paste valid JSON data.';
                statusElement.classList.remove('hidden');
                return;
            }

            try {
                const importedData = JSON.parse(jsonString);
                
                // Basic validation: ensure it's an array and its contents look like projects (checking for 'name' property)
                if (Array.isArray(importedData) && (importedData.length === 0 || importedData.every(item => item && typeof item === 'object' && item.name))) {
                    
                    // Replace current data and save
                    projects = importedData;
                    saveProjectsToStorage(); 
                    
                    showCustomMessage(`Successfully imported ${projects.length} projects!`, 'green');

                    // Close modal
                    document.getElementById('import-modal').style.display = 'none';
                    inputElement.value = '';

                } else {
                    throw new Error("Data must be a valid array of project objects.");
                }
            } catch (error) {
                console.error("Import Error:", error);
                statusElement.textContent = `Invalid JSON format or data structure. Please ensure you pasted the full project array.`;
                statusElement.classList.remove('hidden');
            }
        };

        // --- Rendering Functions ---

        /** Renders a single project card. */
        const createProjectCard = (project) => {
            const card = document.createElement('div');
            card.className = 'bg-card border border-gray-800 rounded-xl p-5 shadow-xl transition duration-300 hover:border-primary/50';

            // Calculations
            const estimatedDays = project.estimatedDays || 1;
            const actualDays = project.actualDays || 0;
            const myPerDayCost = project.myPerDayCost || 0;
            const myShareCost = project.myShareCost || 0;
            const totalProjectCost = project.totalProjectCost || 0;

            const effortVariance = actualDays - estimatedDays;
            const variance = getVarianceStyle(effortVariance);
            const myActualEffortCost = actualDays * myPerDayCost;
            const financialHealth = myShareCost - myActualEffortCost;

            const completionPct = Math.min(100, (actualDays / estimatedDays) * 100).toFixed(0);
            const progressBarColor = completionPct > 100 ? 'bg-red-600' : 'bg-green-600';

            // Status Badge Colors
            const statusColors = {
                'Planned': 'bg-blue-500/20 text-blue-300',
                'In Progress': 'bg-yellow-500/20 text-yellow-300',
                'On Hold': 'bg-gray-500/20 text-gray-300',
                'Complete': 'bg-green-500/20 text-green-300',
            };
            const statusBadgeClass = statusColors[project.status] || 'bg-gray-500/20 text-gray-300';
            
            // Financial Health Icon/Color
            const healthStyle = financialHealth >= 0 
                ? { color: 'text-green-400', icon: 'dollar-sign' }
                : { color: 'text-red-400', icon: 'wallet' };

            // HTML Structure
            card.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-xl font-bold text-white">${project.name}</h3>
                    <div class="flex space-x-2">
                        <span class="text-xs font-semibold px-3 py-1 rounded-full ${statusBadgeClass}">${project.status}</span>
                    </div>
                </div>

                <div class="text-sm mb-4 space-y-2">
                    <p class="text-gray-400"><i data-lucide="tag" class="w-4 h-4 inline mr-2"></i>Type: <span class="text-white">${project.type}</span></p>
                    <p class="text-gray-400"><i data-lucide="code" class="w-4 h-4 inline mr-2"></i>Tech Stack: <span class="text-white">${project.techStack || 'N/A'}</span></p>
                </div>

                <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 border-t border-b border-gray-800 py-4 mb-4">
                    <!-- Metric 1: My Effort Cost -->
                    <div class="p-3 bg-secondary rounded-lg">
                        <p class="text-xs text-gray-400">My Actual Cost/Earned</p>
                        <p class="text-base font-semibold text-primary">${formatCurrency(myActualEffortCost)}</p>
                    </div>

                    <!-- Metric 2: Effort Variance -->
                    <div class="p-3 bg-secondary rounded-lg">
                        <p class="text-xs text-gray-400">Effort Variance</p>
                        <p class="text-base font-semibold ${variance.color} flex items-center">
                            <i data-lucide="${variance.icon}" class="w-4 h-4 mr-1"></i>
                            ${variance.text}
                        </p>
                    </div>
                    
                    <!-- Metric 3: Financial Health -->
                    <div class="p-3 bg-secondary rounded-lg">
                        <p class="text-xs text-gray-400">Net Health (Share - Cost)</p>
                        <p class="text-base font-semibold ${healthStyle.color}">${formatCurrency(financialHealth)}</p>
                    </div>

                    <!-- Metric 4: My Share Pct -->
                    <div class="p-3 bg-secondary rounded-lg">
                        <p class="text-xs text-gray-400">My Share / Total Cost</p>
                        <p class="text-base font-semibold text-white">
                            ${myShareCost > 0 && totalProjectCost > 0 ? (myShareCost / totalProjectCost * 100).toFixed(1) + '%' : 'N/A'}
                        </p>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="mb-4">
                    <div class="flex justify-between text-xs font-medium text-gray-400">
                        <span>Effort Logged: ${actualDays} / ${estimatedDays} Days</span>
                        <span class="text-white">${completionPct}%</span>
                    </div>
                    <div class="w-full bg-secondary rounded-full h-2.5">
                        <div class="${progressBarColor} h-2.5 rounded-full" style="width: ${completionPct}%"></div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex justify-end space-x-3 mt-4 pt-4 border-t border-gray-900">
                    <button data-id="${project.id}" data-name="${project.name}" class="delete-btn text-red-500 hover:text-red-400 transition duration-200 p-1 rounded-lg hover:bg-red-900/20">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                    <button data-id="${project.id}" class="edit-btn text-primary hover:text-blue-400 transition duration-200 p-1 rounded-lg hover:bg-blue-900/20">
                        <i data-lucide="square-pen" class="w-5 h-5"></i>
                    </button>
                </div>
            `;
            
            // Re-render lucide icons inside the card
            setTimeout(() => lucide.createIcons(), 0); 
            return card;
        };

        /** Renders the dashboard summary cards. */
        const renderDashboardSummary = (projects) => {
            const summary = {
                totalProjects: projects.length,
                inProgress: projects.filter(p => p.status === 'In Progress').length,
                totalEstimatedDays: projects.reduce((sum, p) => sum + (p.estimatedDays || 0), 0),
                totalActualCost: projects.reduce((sum, p) => sum + ((p.actualDays || 0) * (p.myPerDayCost || 0)), 0),
            };

            const cards = [
                { title: 'Total Projects', value: summary.totalProjects, icon: 'list-checks', color: 'text-primary' },
                { title: 'In Progress', value: summary.inProgress, icon: 'rotate-cw', color: 'text-yellow-400' },
                { title: 'Total Est. Days', value: summary.totalEstimatedDays.toLocaleString(), icon: 'calendar-days', color: 'text-indigo-400' },
                { title: 'Total Actual Cost', value: formatCurrency(summary.totalActualCost), icon: 'trending-up', color: 'text-green-400' },
            ];

            dashboardSummary.innerHTML = cards.map(card => `
                <div class="bg-card p-5 rounded-xl shadow-lg border border-gray-800 flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-400">${card.title}</p>
                        <p class="text-3xl font-bold ${card.color} mt-1">${card.value}</p>
                    </div>
                    <i data-lucide="${card.icon}" class="w-8 h-8 ${card.color} opacity-40"></i>
                </div>
            `).join('');

            lucide.createIcons();
        };

        /** Renders all projects and updates the dashboard. */
        const renderProjects = () => {
            projectListContainer.innerHTML = '';
            
            if (projects.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                projects.forEach(project => {
                    projectListContainer.appendChild(createProjectCard(project));
                });
            }
            renderDashboardSummary(projects);
        };

        // --- Initialization and Event Listeners ---
        
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Initial Load
            loadProjectsFromStorage();
            renderProjects();
            
            // 2. Set up Modals and Form Logic
            const projectModal = document.getElementById('project-modal');
            const importModal = document.getElementById('import-modal');

            document.getElementById('add-project-btn').addEventListener('click', () => openModal());
            
            document.getElementById('close-modal-btn').addEventListener('click', () => projectModal.style.display = 'none');
            document.getElementById('project-form').addEventListener('submit', saveProject);
            
            // Close delete modal
            document.getElementById('cancel-delete-btn').addEventListener('click', () => document.getElementById('delete-modal').style.display = 'none');
            // Confirm delete
            document.getElementById('confirm-delete-btn').addEventListener('click', deleteProject);

            // Handle Clicks on project cards (Edit/Delete delegation)
            projectListContainer.addEventListener('click', (e) => {
                const button = e.target.closest('.edit-btn') || e.target.closest('.delete-btn');
                if (!button) return;

                const projectId = button.dataset.id;
                const project = projects.find(p => p.id === projectId);

                if (button.classList.contains('edit-btn')) {
                    if (project) openModal(project);
                } else if (button.classList.contains('delete-btn')) {
                    if (project) initiateDelete(projectId, project.name);
                }
            });

            // 3. File Management Listeners
            document.getElementById('export-data-btn').addEventListener('click', initiateExport);
            
            document.getElementById('import-data-btn').addEventListener('click', initiateImport);
            document.getElementById('close-import-modal-btn').addEventListener('click', () => importModal.style.display = 'none');
            document.getElementById('import-form').addEventListener('submit', importData);

            // 4. Initial Icon Render
            lucide.createIcons();
        });
    </script>
</body>
</html>
